# 系统通知功能实现说明

## 功能概述

已完整实现任务截止时间系统通知功能，当任务即将到期时会自动发送系统通知提醒用户。

## 实现内容

### 1. 后端实现 (Rust)

#### 依赖添加
- 在 `Cargo.toml` 中添加了 `tauri-plugin-notification = "2"` 依赖

#### 通知管理模块 (`src-tauri/src/notification/mod.rs`)
- `NotificationManager` 结构体：管理通知发送和去重
- `check_and_notify()` 方法：检查所有任务并发送通知
- `send_notification()` 方法：发送系统通知
- 通知去重机制：避免重复发送同一任务的通知

#### 设置模型更新
- `AppSettings` 结构体新增字段：
  - `enable_deadline_notification: bool` - 是否启用通知
  - `notification_minutes_before: u32` - 提前多少分钟通知

#### 定时检查机制
- 在应用启动时创建后台线程
- 每60秒检查一次所有未完成任务
- 自动发送符合条件的通知

### 2. 前端实现 (Vue)

#### 设置页面 (`src/Settings.vue`)
新增"倒计时提醒"设置区域：
- **启用倒计时通知**：开关按钮
- **提前提醒时间**：数字输入框（1-1440分钟）
- **测试通知**：测试按钮，验证通知功能

#### TypeScript 类型定义
更新 `AppSettings` 接口，包含通知相关字段

## 使用说明

### 启用通知
1. 打开设置页面
2. 进入"使用设置"标签
3. 找到"倒计时提醒"部分
4. 开启"启用倒计时通知"开关
5. 设置"提前提醒时间"（默认30分钟）
6. 点击"发送测试通知"验证功能

### 通知触发条件
- 任务必须有截止时间
- 任务未完成
- 距离截止时间等于设置的提前时间（±30秒容差）
- 该任务尚未发送过通知

### 通知内容
```
标题：DeskHive 任务提醒
内容：任务即将到期 (HH:MM)
     [任务文本]
```

## 技术细节

### 通知检查逻辑
1. 每分钟执行一次检查
2. 加载应用设置，检查是否启用通知
3. 加载所有待办事项数据
4. 遍历所有未完成且有截止时间的任务
5. 计算距离截止时间的秒数
6. 如果在通知窗口内且未通知过，发送通知
7. 记录已通知的任务ID，避免重复

### 通知去重机制
- 使用 `HashSet` 存储已通知的任务ID
- 任务超期1小时后自动清理记录
- 应用重启后重置通知记录

### 时间计算
- 使用 UTC 时间戳进行计算
- 通知显示时转换为本地时间
- 容差范围：±30秒（避免因定时器误差漏发通知）

## 系统要求

### Windows
- Windows 10 或更高版本
- 需要在系统设置中允许应用发送通知

### 权限设置
1. 打开 Windows 设置
2. 进入"系统" > "通知"
3. 找到 DeskHive 应用
4. 确保通知权限已开启

## 测试方法

### 方法1：使用测试按钮
1. 在设置页面点击"发送测试通知"
2. 应该立即收到测试通知

### 方法2：创建测试任务
1. 创建一个新任务
2. 设置截止时间为当前时间 + 提前提醒时间
3. 等待通知（最多等待1分钟）

例如：
- 当前时间：14:00
- 提前提醒时间：30分钟
- 设置截止时间：14:30
- 预期通知时间：14:00（立即或1分钟内）

## 故障排查

### 没有收到通知
1. 检查是否启用了"启用倒计时通知"
2. 检查系统通知权限是否开启
3. 使用"发送测试通知"按钮测试
4. 检查任务是否有截止时间
5. 检查任务是否未完成
6. 确认距离截止时间等于设置的提前时间

### 通知重复发送
- 正常情况下不会重复发送
- 如果应用重启，可能会重新发送一次

### 通知延迟
- 检查间隔为60秒，可能有最多1分钟的延迟
- 这是正常现象，用于节省系统资源

## 未来改进建议

1. 支持多次提醒（例如：提前1天、1小时、30分钟）
2. 自定义通知声音
3. 通知点击后跳转到对应任务
4. 支持通知历史记录
5. 更精确的通知时间（减少检查间隔）
6. 支持通知优先级设置
